---
layout: post
title: 性能调优举例四
categories: [java,性能调优,jvm,举例]
description: 性能调优分析举例
keywords: 在线性能调优 , jvm ,思考,java,性能调优,jvm,举例
---

问题描述：重复导出导致的DB性能压力报告与解决方案

## 问题

同样的SQL，参数也一样，短时间了执行24次，给DB造成了很大性能压力。

## 分析

首先，我们的系统进行了慢sql监控，通过查询ES监控结果,发现确实有属于同一个用户id的，24个同样的慢sql，
再分析该sql对应的action请求属于:

xxxAction.exportXXyy方法

继续分析该用户id的该 exportXXyy 的Nginx应用程序访问请求:

我们发现该段时间内499的请求很多，而且前后时间差别相隔很短.

继续分析我们发现原因:

前端用户点导出按钮没有导出数据时候，用户会不停的点击，而每次点击，会cancel掉上次的请求，所以客户端提前终止，于是就有499.

这个用户id的nginx请求大部分是499。

这也解释这一个用户操作，大部分的导出操作浪费掉了，实际比例是

浪费请求：有效请求=24:1  也就是这个慢sql. DB浪费掉了24倍

所以这个看是不起眼的请求会导致CPU 99%!

## 解决方案

1. 前端点击导出前先发一个allow请求到后端，是否该请求导出是否已经完成，若进行中，返回notAllowed,否则返回allowed

2. 根据allowed,来继续请求是否应该下载文件

3. 后端实现用拦截器拦截导出的这类请求，处理过程中根据用户，导出类型，给redis写一个导出中的状态，结束再写入完成，或者删除这个key。